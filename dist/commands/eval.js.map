{"version":3,"sources":["../../src/commands/eval.ts"],"sourcesContent":["import { codeBlock } from \"@discordjs/builders\";\nimport {\n\tApplicationCommandOptionType,\n\tApplicationCommandType,\n} from \"discord-api-types/v10\";\nimport type {\n\tApplicationCommandOptionChoiceData,\n\tAutocompleteInteraction,\n\tChatInputCommandInteraction,\n\tInteraction,\n} from \"discord.js\";\nimport { Colors, escapeCodeBlock } from \"discord.js\";\nimport EventEmitter, { once } from \"node:events\";\nimport { performance } from \"node:perf_hooks\";\nimport { nextTick } from \"node:process\";\nimport type { REPLServer, writer } from \"node:repl\";\nimport { REPL_MODE_STRICT, start } from \"node:repl\";\nimport { Readable, Writable } from \"node:stream\";\nimport { createCommand, CustomClient } from \"../util\";\n\nconst input = new Readable({\n\thighWaterMark: 1e6,\n\tencoding: \"utf8\",\n\tread: () => {\n\t\t// noop\n\t},\n});\nconst output = new EventEmitter({ captureRejections: true });\nconst replServer = start({\n\tinput,\n\toutput: new Writable({\n\t\tdefaultEncoding: \"utf8\",\n\t\thighWaterMark: 1e6,\n\t\tdecodeStrings: false,\n\t\twrite: (chunk, _, next) => {\n\t\t\toutput.emit(\"data\", chunk);\n\t\t\tnext();\n\t\t},\n\t}),\n\tprompt: \"\",\n\treplMode: REPL_MODE_STRICT,\n}) as REPLServer & { readonly writer: typeof writer };\nconst addContext = (interaction: Interaction) => {\n\t// eslint-disable-next-line @typescript-eslint/no-use-before-define\n\treplServer.context.command = command;\n\treplServer.context.replServer = replServer;\n\treplServer.context.interaction = interaction;\n\treplServer.context.client = interaction.client;\n};\nconst setInspectOptions = (\n\tinteraction: AutocompleteInteraction | ChatInputCommandInteraction\n) => {\n\tconst { options } = replServer.writer;\n\tconst clientStatus = interaction.guild?.presences.cache.get(\n\t\tinteraction.user.id\n\t)?.clientStatus;\n\tconst isPC = clientStatus?.desktop != null && clientStatus.mobile == null;\n\n\toptions.colors = isPC;\n\toptions.showHidden = interaction.options.getBoolean(\"show-hidden\") ?? false;\n\toptions.depth = interaction.options.getInteger(\"depth\") ?? 3;\n\toptions.showProxy = interaction.options.getBoolean(\"show-proxy\") ?? true;\n\toptions.maxArrayLength =\n\t\tinteraction.options.getInteger(\"max-array-length\") ?? 100;\n\toptions.maxStringLength =\n\t\tinteraction.options.getInteger(\"max-string-length\") ?? 1000;\n\toptions.breakLength = isPC ? 66 : 39;\n};\n\nexport const command = createCommand({\n\tdata: [\n\t\t{\n\t\t\tname: \"eval\",\n\t\t\tdescription: \"Esegui del codice JavaScript\",\n\t\t\ttype: ApplicationCommandType.ChatInput,\n\t\t\toptions: [\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.String,\n\t\t\t\t\tname: \"code\",\n\t\t\t\t\tdescription: \"Codice da eseguire\",\n\t\t\t\t\trequired: true,\n\t\t\t\t\tautocomplete: true,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Boolean,\n\t\t\t\t\tname: \"show-hidden\",\n\t\t\t\t\tdescription: \"Se mostrare le proprietà nascoste (default: false)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Integer,\n\t\t\t\t\tname: \"depth\",\n\t\t\t\t\tdescription: \"Profondità di esecuzione (default: 3)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Boolean,\n\t\t\t\t\tname: \"show-proxy\",\n\t\t\t\t\tdescription: \"Se includere le proprietà proxy (default: true)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Integer,\n\t\t\t\t\tname: \"max-array-length\",\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"Il numero massimo di elementi da mostrare in un array (default: 100)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Integer,\n\t\t\t\t\tname: \"max-string-length\",\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"Il numero massimo di caratteri da mostrare in una stringa (default: 1000)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Boolean,\n\t\t\t\t\tname: \"ephemeral\",\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"Se il risultato può essere visto solo da te (default: true)\",\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t],\n\tisPrivate: true,\n\tasync run(interaction) {\n\t\tconst code = interaction.options.getString(\"code\", true);\n\t\tconst ephemeral = interaction.options.getBoolean(\"ephemeral\") ?? true;\n\t\tlet delay!: number;\n\t\tconst previous = performance.now();\n\t\tconst [result] = await Promise.all([\n\t\t\tnew Promise<string>((resolve) => {\n\t\t\t\tlet value = \"\";\n\t\t\t\tlet immediateId: NodeJS.Immediate;\n\t\t\t\tconst callback = (chunk: string) => {\n\t\t\t\t\tchunk = chunk.trim();\n\t\t\t\t\tif (!chunk) return;\n\t\t\t\t\tclearImmediate(immediateId);\n\t\t\t\t\tdelay = performance.now() - previous;\n\t\t\t\t\tvalue += `\\n${chunk}`;\n\t\t\t\t\timmediateId = setImmediate(() => {\n\t\t\t\t\t\tresolve(value);\n\t\t\t\t\t\toutput.removeListener(\"data\", callback);\n\t\t\t\t\t\tdelete replServer.context.interaction;\n\t\t\t\t\t});\n\t\t\t\t};\n\n\t\t\t\toutput.on(\"data\", callback);\n\t\t\t\tsetInspectOptions(interaction);\n\t\t\t\taddContext(interaction);\n\t\t\t\tinput.push(`${code}\\n`);\n\t\t\t}),\n\t\t\tinteraction\n\t\t\t\t.deferReply({\n\t\t\t\t\tephemeral,\n\t\t\t\t})\n\t\t\t\t.catch(CustomClient.printToStderr),\n\t\t]);\n\n\t\tawait interaction.editReply({\n\t\t\tcontent: `Eval elaborato in ${delay}ms`,\n\t\t\tembeds: [\n\t\t\t\t{\n\t\t\t\t\tauthor: {\n\t\t\t\t\t\tname: interaction.user.tag,\n\t\t\t\t\t\ticon_url: interaction.user.displayAvatarURL(),\n\t\t\t\t\t},\n\t\t\t\t\ttitle: \"Eval output\",\n\t\t\t\t\tdescription: codeBlock(\n\t\t\t\t\t\t\"ansi\",\n\t\t\t\t\t\tescapeCodeBlock(result).slice(0, 4096 - 11)\n\t\t\t\t\t),\n\t\t\t\t\tcolor: Colors.Blurple,\n\t\t\t\t\ttimestamp: new Date().toISOString(),\n\t\t\t\t\tfields: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: \"Input\",\n\t\t\t\t\t\t\tvalue: codeBlock(\"js\", escapeCodeBlock(code).slice(0, 1024 - 9)),\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\t},\n\tasync autocomplete(interaction) {\n\t\tconst option = interaction.options.getFocused(true);\n\n\t\tif (option.name !== \"code\") return;\n\t\tif (option.value.length >= 100) {\n\t\t\tawait interaction.respond([]);\n\t\t\treturn;\n\t\t}\n\t\taddContext(interaction);\n\t\tconst split = option.value.split(\"\\n\");\n\t\tconst old = `${split.slice(0, -1).join(\" \")} `.trim();\n\t\tconst last = split.at(-1)!;\n\t\tconst [autocomplete, sub] = await new Promise<[string[], string]>(\n\t\t\t(resolve) => {\n\t\t\t\treplServer.completer(last, (err, r) => {\n\t\t\t\t\tif (err) CustomClient.printToStderr(err);\n\t\t\t\t\tresolve(r ?? [[], \"\"]);\n\t\t\t\t});\n\t\t\t}\n\t\t);\n\t\tif (autocomplete.length === 0) {\n\t\t\tawait interaction.respond([]);\n\t\t\tdelete replServer.context.interaction;\n\t\t\treturn;\n\t\t}\n\t\tlet only: string;\n\t\tif (\n\t\t\t(autocomplete.length === 1 ||\n\t\t\t\t(only = autocomplete.find((a) =>\n\t\t\t\t\tautocomplete.every((b) => b.startsWith(a))\n\t\t\t\t)!)) &&\n\t\t\t!old &&\n\t\t\tsub === last\n\t\t) {\n\t\t\tconst { options } = replServer.writer;\n\n\t\t\tonly ??= autocomplete[0];\n\t\t\tnextTick(() => input.push(`${only}\\n`));\n\t\t\toptions.colors = false;\n\t\t\toptions.showHidden =\n\t\t\t\tinteraction.options.getBoolean(\"show-hidden\") ?? false;\n\t\t\toptions.depth = interaction.options.getInteger(\"depth\") ?? 2;\n\t\t\toptions.showProxy = interaction.options.getBoolean(\"show-proxy\") ?? false;\n\t\t\toptions.maxArrayLength =\n\t\t\t\tinteraction.options.getInteger(\"max-array-length\") ?? 100;\n\t\t\toptions.maxStringLength =\n\t\t\t\tinteraction.options.getInteger(\"max-string-length\") ?? 1000;\n\t\t\toptions.breakLength = Infinity;\n\t\t\toptions.compact = true;\n\t\t\tlet [name]: string[] = await once(output, \"data\");\n\n\t\t\tname = name.trim();\n\t\t\tif (name.length > 100) name = `${name.slice(0, 97).trimEnd()}...`;\n\t\t\tif (name) {\n\t\t\t\tdelete replServer.context.interaction;\n\t\t\t\tonly = only.slice(0, 100);\n\t\t\t\tawait interaction.respond([\n\t\t\t\t\t{\n\t\t\t\t\t\tname: only,\n\t\t\t\t\t\tvalue: only,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tname,\n\t\t\t\t\t\tvalue: only,\n\t\t\t\t\t},\n\t\t\t\t]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tconst options: ApplicationCommandOptionChoiceData[][] = [];\n\t\tlet tempArray: ApplicationCommandOptionChoiceData[] = [];\n\n\t\tfor (const a of autocomplete) {\n\t\t\tif (!a || tempArray.length >= 25) {\n\t\t\t\toptions.push(tempArray);\n\t\t\t\ttempArray = [];\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst value = `${old}${last.replace(new RegExp(`${sub}$`), a)}`;\n\n\t\t\tif (value.length > 100) continue;\n\t\t\ttempArray.push({\n\t\t\t\tname: value,\n\t\t\t\tvalue,\n\t\t\t});\n\t\t}\n\t\toptions.push(tempArray);\n\t\tdelete replServer.context.interaction;\n\t\tawait interaction.respond(options.reverse().flat().slice(0, 25));\n\t},\n});\n"],"mappings":"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","names":[]}