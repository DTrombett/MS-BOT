{"version":3,"sources":["../../src/commands/eval.ts"],"sourcesContent":["import { codeBlock } from \"@discordjs/builders\";\r\nimport {\r\n\tApplicationCommandOptionType,\r\n\tApplicationCommandType,\r\n} from \"discord-api-types/v10\";\r\nimport type {\r\n\tApplicationCommandOptionChoiceData,\r\n\tAutocompleteInteraction,\r\n\tChatInputCommandInteraction,\r\n\tInteraction,\r\n} from \"discord.js\";\r\nimport { Colors, escapeCodeBlock } from \"discord.js\";\r\nimport EventEmitter, { once } from \"node:events\";\r\nimport { performance } from \"node:perf_hooks\";\r\nimport { nextTick } from \"node:process\";\r\nimport type { REPLServer, writer } from \"node:repl\";\r\nimport { REPL_MODE_STRICT, start } from \"node:repl\";\r\nimport { Readable, Writable } from \"node:stream\";\r\nimport { createCommand, CustomClient } from \"../util\";\r\n\r\nconst input = new Readable({\r\n\thighWaterMark: 1e6,\r\n\tencoding: \"utf8\",\r\n\tread: () => {\r\n\t\t// noop\r\n\t},\r\n});\r\nconst output = new EventEmitter({ captureRejections: true });\r\nconst replServer = start({\r\n\tinput,\r\n\toutput: new Writable({\r\n\t\tdefaultEncoding: \"utf8\",\r\n\t\thighWaterMark: 1e6,\r\n\t\tdecodeStrings: false,\r\n\t\twrite: (chunk, _, next) => {\r\n\t\t\toutput.emit(\"data\", chunk);\r\n\t\t\tnext();\r\n\t\t},\r\n\t}),\r\n\tprompt: \"\",\r\n\treplMode: REPL_MODE_STRICT,\r\n}) as REPLServer & { readonly writer: typeof writer };\r\nconst addContext = (interaction: Interaction) => {\r\n\t// eslint-disable-next-line @typescript-eslint/no-use-before-define\r\n\treplServer.context.command = command;\r\n\treplServer.context.replServer = replServer;\r\n\treplServer.context.interaction = interaction;\r\n\treplServer.context.client = interaction.client;\r\n};\r\nconst setInspectOptions = (\r\n\tinteraction: AutocompleteInteraction | ChatInputCommandInteraction\r\n) => {\r\n\tconst { options } = replServer.writer;\r\n\tconst clientStatus = interaction.guild?.presences.cache.get(\r\n\t\tinteraction.user.id\r\n\t)?.clientStatus;\r\n\tconst isPC = clientStatus?.desktop != null && clientStatus.mobile == null;\r\n\r\n\toptions.colors = isPC;\r\n\toptions.showHidden = interaction.options.getBoolean(\"show-hidden\") ?? false;\r\n\toptions.depth = interaction.options.getInteger(\"depth\") ?? 3;\r\n\toptions.showProxy = interaction.options.getBoolean(\"show-proxy\") ?? true;\r\n\toptions.maxArrayLength =\r\n\t\tinteraction.options.getInteger(\"max-array-length\") ?? 100;\r\n\toptions.maxStringLength =\r\n\t\tinteraction.options.getInteger(\"max-string-length\") ?? 1000;\r\n\toptions.breakLength = isPC ? 66 : 39;\r\n};\r\n\r\nexport const command = createCommand({\r\n\tdata: [\r\n\t\t{\r\n\t\t\tname: \"eval\",\r\n\t\t\tdescription: \"Esegui del codice JavaScript\",\r\n\t\t\ttype: ApplicationCommandType.ChatInput,\r\n\t\t\toptions: [\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: ApplicationCommandOptionType.String,\r\n\t\t\t\t\tname: \"code\",\r\n\t\t\t\t\tdescription: \"Codice da eseguire\",\r\n\t\t\t\t\trequired: true,\r\n\t\t\t\t\tautocomplete: true,\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: ApplicationCommandOptionType.Boolean,\r\n\t\t\t\t\tname: \"show-hidden\",\r\n\t\t\t\t\tdescription: \"Se mostrare le proprietà nascoste (default: false)\",\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: ApplicationCommandOptionType.Integer,\r\n\t\t\t\t\tname: \"depth\",\r\n\t\t\t\t\tdescription: \"Profondità di esecuzione (default: 3)\",\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: ApplicationCommandOptionType.Boolean,\r\n\t\t\t\t\tname: \"show-proxy\",\r\n\t\t\t\t\tdescription: \"Se includere le proprietà proxy (default: true)\",\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: ApplicationCommandOptionType.Integer,\r\n\t\t\t\t\tname: \"max-array-length\",\r\n\t\t\t\t\tdescription:\r\n\t\t\t\t\t\t\"Il numero massimo di elementi da mostrare in un array (default: 100)\",\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: ApplicationCommandOptionType.Integer,\r\n\t\t\t\t\tname: \"max-string-length\",\r\n\t\t\t\t\tdescription:\r\n\t\t\t\t\t\t\"Il numero massimo di caratteri da mostrare in una stringa (default: 1000)\",\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\ttype: ApplicationCommandOptionType.Boolean,\r\n\t\t\t\t\tname: \"ephemeral\",\r\n\t\t\t\t\tdescription:\r\n\t\t\t\t\t\t\"Se il risultato può essere visto solo da te (default: true)\",\r\n\t\t\t\t},\r\n\t\t\t],\r\n\t\t},\r\n\t],\r\n\tisPrivate: true,\r\n\tasync run(interaction) {\r\n\t\tconst code = interaction.options.getString(\"code\", true);\r\n\t\tconst ephemeral = interaction.options.getBoolean(\"ephemeral\") ?? true;\r\n\t\tlet delay!: number;\r\n\t\tconst previous = performance.now();\r\n\t\tconst [result] = await Promise.all([\r\n\t\t\tnew Promise<string>((resolve) => {\r\n\t\t\t\tlet value = \"\";\r\n\t\t\t\tlet immediateId: NodeJS.Immediate;\r\n\t\t\t\tconst callback = (chunk: string) => {\r\n\t\t\t\t\tchunk = chunk.trim();\r\n\t\t\t\t\tif (!chunk) return;\r\n\t\t\t\t\tclearImmediate(immediateId);\r\n\t\t\t\t\tdelay = performance.now() - previous;\r\n\t\t\t\t\tvalue += `\\n${chunk}`;\r\n\t\t\t\t\timmediateId = setImmediate(() => {\r\n\t\t\t\t\t\tresolve(value);\r\n\t\t\t\t\t\toutput.removeListener(\"data\", callback);\r\n\t\t\t\t\t\tdelete replServer.context.interaction;\r\n\t\t\t\t\t});\r\n\t\t\t\t};\r\n\r\n\t\t\t\toutput.on(\"data\", callback);\r\n\t\t\t\tsetInspectOptions(interaction);\r\n\t\t\t\taddContext(interaction);\r\n\t\t\t\tinput.push(`${code}\\n`);\r\n\t\t\t}),\r\n\t\t\tinteraction\r\n\t\t\t\t.deferReply({\r\n\t\t\t\t\tephemeral,\r\n\t\t\t\t})\r\n\t\t\t\t.catch(CustomClient.printToStderr),\r\n\t\t]);\r\n\r\n\t\tawait interaction.editReply({\r\n\t\t\tcontent: `Eval elaborato in ${delay}ms`,\r\n\t\t\tembeds: [\r\n\t\t\t\t{\r\n\t\t\t\t\tauthor: {\r\n\t\t\t\t\t\tname: interaction.user.tag,\r\n\t\t\t\t\t\ticon_url: interaction.user.displayAvatarURL(),\r\n\t\t\t\t\t},\r\n\t\t\t\t\ttitle: \"Eval output\",\r\n\t\t\t\t\tdescription: codeBlock(\r\n\t\t\t\t\t\t\"ansi\",\r\n\t\t\t\t\t\tescapeCodeBlock(result).slice(0, 4096 - 11)\r\n\t\t\t\t\t),\r\n\t\t\t\t\tcolor: Colors.Blurple,\r\n\t\t\t\t\ttimestamp: new Date().toISOString(),\r\n\t\t\t\t\tfields: [\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tname: \"Input\",\r\n\t\t\t\t\t\t\tvalue: codeBlock(\"js\", escapeCodeBlock(code).slice(0, 1024 - 9)),\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t],\r\n\t\t\t\t},\r\n\t\t\t],\r\n\t\t});\r\n\t},\r\n\tasync autocomplete(interaction) {\r\n\t\tconst option = interaction.options.getFocused(true);\r\n\r\n\t\tif (option.name !== \"code\") return;\r\n\t\tif (option.value.length >= 100) {\r\n\t\t\tawait interaction.respond([]);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\taddContext(interaction);\r\n\t\tconst split = option.value.split(\"\\n\");\r\n\t\tconst old = `${split.slice(0, -1).join(\" \")} `.trim();\r\n\t\tconst last = split.at(-1)!;\r\n\t\tconst [autocomplete, sub] = await new Promise<[string[], string]>(\r\n\t\t\t(resolve) => {\r\n\t\t\t\treplServer.completer(last, (err, r) => {\r\n\t\t\t\t\tif (err) CustomClient.printToStderr(err);\r\n\t\t\t\t\tresolve(r ?? [[], \"\"]);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t);\r\n\t\tif (autocomplete.length === 0) {\r\n\t\t\tawait interaction.respond([]);\r\n\t\t\tdelete replServer.context.interaction;\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst nestedOptions: ApplicationCommandOptionChoiceData[][] = [];\r\n\t\tlet tempArray: ApplicationCommandOptionChoiceData[] = [];\r\n\t\tlet only = autocomplete.find((a) =>\r\n\t\t\tautocomplete.every((b) => b.startsWith(a))\r\n\t\t)!;\r\n\r\n\t\tfor (const a of autocomplete) {\r\n\t\t\tif (!a || tempArray.length >= 25) {\r\n\t\t\t\tnestedOptions.push(tempArray);\r\n\t\t\t\ttempArray = [];\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tif (only && only === a) continue;\r\n\t\t\tconst value = `${old}${last.replace(new RegExp(`${sub}$`), a)}`;\r\n\r\n\t\t\tif (value.length > 100) continue;\r\n\t\t\ttempArray.push({\r\n\t\t\t\tname: value,\r\n\t\t\t\tvalue,\r\n\t\t\t});\r\n\t\t}\r\n\t\tnestedOptions.push(tempArray);\r\n\t\tconst options = nestedOptions.reverse().flat().slice(0, 25);\r\n\r\n\t\tif (only && !old && sub === last) {\r\n\t\t\tconst { options: writerOptions } = replServer.writer;\r\n\r\n\t\t\twriterOptions.colors = false;\r\n\t\t\twriterOptions.showHidden = false;\r\n\t\t\twriterOptions.depth = 2;\r\n\t\t\twriterOptions.showProxy = false;\r\n\t\t\twriterOptions.maxArrayLength = 10;\r\n\t\t\twriterOptions.maxStringLength = 100;\r\n\t\t\twriterOptions.breakLength = Infinity;\r\n\t\t\twriterOptions.compact = true;\r\n\t\t\tnextTick(() => input.push(`${only}\\n`));\r\n\t\t\tlet [name] = (await once(output, \"data\")) as string[];\r\n\r\n\t\t\tname = name.trim();\r\n\t\t\tif (name.length > 100) name = `${name.slice(0, 97).trimEnd()}...`;\r\n\t\t\tif (name) {\r\n\t\t\t\tdelete replServer.context.interaction;\r\n\t\t\t\tonly = only.slice(0, 100);\r\n\t\t\t\tawait interaction.respond([\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tname,\r\n\t\t\t\t\t\tvalue: only,\r\n\t\t\t\t\t},\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tname: only,\r\n\t\t\t\t\t\tvalue: only,\r\n\t\t\t\t\t},\r\n\t\t\t\t\t...options,\r\n\t\t\t\t]);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\t\tdelete replServer.context.interaction;\r\n\t\tawait interaction.respond(options);\r\n\t},\r\n});\r\n"],"mappings":"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","names":[]}