{"version":3,"sources":["../../src/commands/eval.ts"],"sourcesContent":["import { codeBlock } from \"@discordjs/builders\";\nimport {\n\tApplicationCommandOptionType,\n\tApplicationCommandType,\n} from \"discord-api-types/v10\";\nimport type {\n\tApplicationCommandOptionChoiceData,\n\tAutocompleteInteraction,\n\tChatInputCommandInteraction,\n\tInteraction,\n} from \"discord.js\";\nimport { Colors, escapeCodeBlock } from \"discord.js\";\nimport EventEmitter from \"node:events\";\nimport { homedir } from \"node:os\";\nimport { join } from \"node:path\";\nimport { performance } from \"node:perf_hooks\";\nimport type { REPLServer, writer } from \"node:repl\";\nimport { REPL_MODE_STRICT, start } from \"node:repl\";\nimport { Readable, Writable } from \"node:stream\";\nimport { createCommand, CustomClient } from \"../util\";\n\nconst input = new Readable({\n\thighWaterMark: 1e6,\n\tencoding: \"utf8\",\n\tread: () => {\n\t\t// noop\n\t},\n});\nconst output = new EventEmitter({ captureRejections: true });\nconst replServer = start({\n\tinput,\n\toutput: new Writable({\n\t\tdefaultEncoding: \"utf8\",\n\t\thighWaterMark: 1e6,\n\t\tdecodeStrings: false,\n\t\twrite: (chunk, _, next) => {\n\t\t\toutput.emit(\"data\", chunk);\n\t\t\tnext();\n\t\t},\n\t}),\n\tprompt: \"\",\n\treplMode: REPL_MODE_STRICT,\n}) as REPLServer & { writer: typeof writer };\nconst addContext = (interaction: Interaction) => {\n\t// eslint-disable-next-line @typescript-eslint/no-use-before-define\n\treplServer.context.command = command;\n\treplServer.context.replServer = replServer;\n\treplServer.context.interaction = interaction;\n\treplServer.context.client = interaction.client;\n};\nconst setInspectOptions = (\n\tinteraction: AutocompleteInteraction | ChatInputCommandInteraction\n) => {\n\tconst { options } = replServer.writer;\n\tconst isPC = !interaction.guild?.presences.cache.get(interaction.user.id)\n\t\t?.clientStatus?.mobile;\n\n\toptions.colors = isPC;\n\toptions.showHidden = interaction.options.getBoolean(\"show-hidden\") ?? false;\n\toptions.depth = interaction.options.getInteger(\"depth\") ?? 3;\n\toptions.showProxy = interaction.options.getBoolean(\"show-proxy\") ?? true;\n\toptions.maxArrayLength =\n\t\tinteraction.options.getInteger(\"max-array-length\") ?? 100;\n\toptions.maxStringLength =\n\t\tinteraction.options.getInteger(\"max-string-length\") ?? 1000;\n\toptions.breakLength = isPC ? 66 : 39;\n};\n\nreplServer.setupHistory(join(homedir(), \".node_repl_history\"), (err) => {\n\tif (err) CustomClient.printToStderr(err);\n});\n\nexport const command = createCommand({\n\tdata: [\n\t\t{\n\t\t\tname: \"eval\",\n\t\t\tdescription: \"Esegui del codice JavaScript\",\n\t\t\ttype: ApplicationCommandType.ChatInput,\n\t\t\toptions: [\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.String,\n\t\t\t\t\tname: \"code\",\n\t\t\t\t\tdescription: \"Codice da eseguire\",\n\t\t\t\t\trequired: true,\n\t\t\t\t\tautocomplete: true,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Boolean,\n\t\t\t\t\tname: \"show-hidden\",\n\t\t\t\t\tdescription: \"Se mostrare le proprietà nascoste (default: false)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Integer,\n\t\t\t\t\tname: \"depth\",\n\t\t\t\t\tdescription: \"Profondità di esecuzione (default: 3)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Boolean,\n\t\t\t\t\tname: \"show-proxy\",\n\t\t\t\t\tdescription: \"Se includere le proprietà proxy (default: true)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Integer,\n\t\t\t\t\tname: \"max-array-length\",\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"Il numero massimo di elementi da mostrare in un array (default: 100)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Integer,\n\t\t\t\t\tname: \"max-string-length\",\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"Il numero massimo di caratteri da mostrare in una stringa (default: 1000)\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttype: ApplicationCommandOptionType.Boolean,\n\t\t\t\t\tname: \"ephemeral\",\n\t\t\t\t\tdescription:\n\t\t\t\t\t\t\"Se il risultato può essere visto solo da te (default: true)\",\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t],\n\tisPrivate: true,\n\tasync run(interaction) {\n\t\tlet delay!: number;\n\t\tconst code = interaction.options.getString(\"code\", true);\n\t\tconst previous = performance.now();\n\t\tconst ephemeral = interaction.options.getBoolean(\"ephemeral\") ?? true;\n\t\tconst [result] = await Promise.all([\n\t\t\tnew Promise<string>((resolve) => {\n\t\t\t\toutput.once(\"data\", (chunk) => {\n\t\t\t\t\tdelay = performance.now() - previous;\n\t\t\t\t\tresolve(\n\t\t\t\t\t\ttypeof chunk === \"string\"\n\t\t\t\t\t\t\t? chunk.slice(0, -1)\n\t\t\t\t\t\t\t: CustomClient.inspect(chunk)\n\t\t\t\t\t);\n\t\t\t\t\tdelete replServer.context.interaction;\n\t\t\t\t});\n\t\t\t\tsetInspectOptions(interaction);\n\t\t\t\taddContext(interaction);\n\t\t\t\tinput.push(`${code}\\n`);\n\t\t\t}),\n\t\t\tinteraction\n\t\t\t\t.deferReply({\n\t\t\t\t\tephemeral,\n\t\t\t\t})\n\t\t\t\t.catch(CustomClient.printToStderr),\n\t\t]);\n\n\t\tawait interaction.editReply({\n\t\t\tcontent: `Eval elaborato in ${delay}ms`,\n\t\t\tembeds: [\n\t\t\t\t{\n\t\t\t\t\tauthor: {\n\t\t\t\t\t\tname: interaction.user.tag,\n\t\t\t\t\t\ticon_url: interaction.user.displayAvatarURL(),\n\t\t\t\t\t},\n\t\t\t\t\ttitle: \"Eval output\",\n\t\t\t\t\tdescription: codeBlock(\n\t\t\t\t\t\t\"ansi\",\n\t\t\t\t\t\tescapeCodeBlock(result).slice(0, 4096 - 11)\n\t\t\t\t\t),\n\t\t\t\t\tcolor: Colors.Blurple,\n\t\t\t\t\ttimestamp: new Date().toISOString(),\n\t\t\t\t\tfields: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: \"Input\",\n\t\t\t\t\t\t\tvalue: codeBlock(\"js\", escapeCodeBlock(code).slice(0, 1024 - 9)),\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\t},\n\tasync autocomplete(interaction) {\n\t\tconst option = interaction.options.getFocused(true);\n\n\t\tif (option.name !== \"code\") return;\n\t\tif (option.value.length >= 100) {\n\t\t\tawait interaction.respond([]);\n\t\t\treturn;\n\t\t}\n\t\taddContext(interaction);\n\t\tconst split = option.value.split(\"\\n\");\n\t\tconst old = `${split.slice(0, -1).join(\" \")} `.trim();\n\t\tconst last = split.at(-1)!;\n\t\tconst autocomplete = await new Promise<string[]>((resolve) => {\n\t\t\treplServer.completer(last, (err, r) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tCustomClient.printToStderr(err);\n\t\t\t\t\tresolve([]);\n\t\t\t\t} else resolve(r?.[0] ?? []);\n\t\t\t\tdelete replServer.context.interaction;\n\t\t\t});\n\t\t});\n\n\t\tawait interaction.respond(\n\t\t\tautocomplete\n\t\t\t\t.slice(0, 25)\n\t\t\t\t.map<ApplicationCommandOptionChoiceData | null>((a) => {\n\t\t\t\t\tlet n = a;\n\n\t\t\t\t\tfor (let i = 0; i < last.length; i++)\n\t\t\t\t\t\tif (a.startsWith(last.slice(i))) {\n\t\t\t\t\t\t\tn = `${last.slice(0, i)}${a}`;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\tif (!n) return null;\n\t\t\t\t\tconst value = `${old}${n}`;\n\n\t\t\t\t\tif (value.length > 100) return null;\n\t\t\t\t\treturn {\n\t\t\t\t\t\tname: value,\n\t\t\t\t\t\tvalue,\n\t\t\t\t\t};\n\t\t\t\t})\n\t\t\t\t.filter((v): v is ApplicationCommandOptionChoiceData => v != null)\n\t\t);\n\t},\n});\n"],"mappings":"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","names":[]}